@using System.Linq
@using Microsoft.AspNetCore.Identity
@using LicenseWatch.Web.Security
@using LicenseWatch.Core.Jobs
@using LicenseWatch.Infrastructure.Bootstrap
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject IPermissionService PermissionService
@inject IBootstrapSettingsStore SettingsStore
@{
    var cspNonce = Context.Items["CspNonce"] as string;
    var userName = User?.Identity?.Name;
    var isSignedIn = User is not null && SignInManager.IsSignedIn(User);
    var isSystemAdmin = User?.IsInRole("SystemAdmin") == true;
    var area = ViewContext.RouteData.Values["area"]?.ToString();
    var isAdminArea = string.Equals(area, "Admin", StringComparison.OrdinalIgnoreCase);
    var themePreference = Context.Request.Cookies["lw-theme"];
    var themeAttribute = themePreference is "dark" or "light" ? themePreference : null;
    var permissionSet = isSignedIn ? await PermissionService.GetPermissionsAsync(User) : Array.Empty<string>();
    var hasAdminAccess = isSystemAdmin || permissionSet.Count > 0;
    var canRunJobs = isSystemAdmin || permissionSet.Contains(PermissionKeys.JobsRun);
    var canViewJobs = isSystemAdmin || permissionSet.Contains(PermissionKeys.JobsView);
    var canViewReports = isSystemAdmin || permissionSet.Contains(PermissionKeys.ReportsView);
    var isDashboard = isAdminArea
        && string.Equals(ViewContext.RouteData.Values["controller"]?.ToString(), "Home", StringComparison.OrdinalIgnoreCase)
        && string.Equals(ViewContext.RouteData.Values["action"]?.ToString(), "Index", StringComparison.OrdinalIgnoreCase);
    string avatarInitial = userName is not null && userName.Length > 0
        ? userName[..1].ToUpperInvariant()
        : "?";
    var environmentLabel = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ?? "Unknown";
    var bootstrapSettings = await SettingsStore.LoadAsync();
    var brandingName = string.IsNullOrWhiteSpace(bootstrapSettings.Branding.CompanyName)
        ? bootstrapSettings.AppName
        : bootstrapSettings.Branding.CompanyName;
    var brandingLogoUrl = string.IsNullOrWhiteSpace(bootstrapSettings.Branding.LogoFileName)
        ? null
        : $"/app-data/branding/{bootstrapSettings.Branding.LogoFileName}";
}
<!DOCTYPE html>
<html lang="en"@(string.IsNullOrWhiteSpace(themeAttribute) ? "" : $" data-theme=\"{themeAttribute}\"")>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - LicenseWatch</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/%40fontsource/manrope@5.0.12/index.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/%40fontsource/sora@5.0.12/index.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="~/css/theme.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/LicenseWatch.Web.styles.css" asp-append-version="true" />
    @await RenderSectionAsync("Head", required: false)
</head>
<body class="lw-shell bg-page">
    <header class="lw-topbar">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid px-3 px-lg-4">
                @if (isAdminArea && hasAdminAccess)
                {
                    <button class="btn btn-light lw-btn d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminNav" aria-controls="adminNav">
                        <i class="bi bi-list"></i>
                        <span class="visually-hidden">Open navigation</span>
                    </button>
                }
                <a class="navbar-brand fw-semibold d-flex align-items-center gap-2" asp-controller="Home" asp-action="Index" aria-label="LicenseWatch home">
                    @if (!string.IsNullOrWhiteSpace(brandingLogoUrl))
                    {
                        <img src="@brandingLogoUrl" alt="@brandingName logo" class="lw-logo lw-logo--sm" />
                    }
                    else
                    {
                        <partial name="_Logo" model="@("lw-logo--sm")" />
                    }
                    <span>@brandingName</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topbarNav" aria-controls="topbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="topbarNav">
                    @if (!isAdminArea)
                    {
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link @(NavActive("Home") ? "active" : string.Empty)" asp-controller="Home" asp-action="Index">Home</a>
                            </li>
                            @if (hasAdminAccess)
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Admin" asp-controller="Home" asp-action="Index">
                                        <i class="bi bi-shield-lock-fill me-1"></i> Admin
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                    <div class="ms-auto d-flex flex-column flex-lg-row align-items-lg-center gap-2">
                        @if (isAdminArea && hasAdminAccess)
                        {
                            <form class="lw-search d-none d-lg-flex" asp-area="Admin" asp-controller="Licenses" asp-action="Index" method="get" role="search">
                                <i class="bi bi-search"></i>
                                <input class="form-control form-control-sm" type="search" name="search" placeholder="Search licenses, vendors, categories" aria-label="Search licenses" />
                            </form>
                            <div class="dropdown">
                                <button class="btn btn-light lw-btn d-flex align-items-center gap-1 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-lightning-charge"></i>
                                    <span class="d-none d-lg-inline">Quick actions</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    @if (canRunJobs)
                                    {
                                        <li>
                                            <form asp-area="Admin" asp-controller="Jobs" asp-action="Run" asp-route-jobKey="@JobKeys.ComplianceEvaluation" method="post" class="d-inline">
                                                <button type="submit" class="dropdown-item" data-loading-text="Running..."><i class="bi bi-shield-check me-2"></i>Run compliance check</button>
                                            </form>
                                        </li>
                                        <li>
                                            <form asp-area="Admin" asp-controller="Jobs" asp-action="Run" asp-route-jobKey="@JobKeys.UsageAggregation" method="post" class="d-inline">
                                                <button type="submit" class="dropdown-item" data-loading-text="Running..."><i class="bi bi-graph-up-arrow me-2"></i>Refresh usage signals</button>
                                            </form>
                                        </li>
                                        <li>
                                            <form asp-area="Admin" asp-controller="Jobs" asp-action="Run" asp-route-jobKey="@JobKeys.Notifications" method="post" class="d-inline">
                                                <button type="submit" class="dropdown-item" data-loading-text="Running..."><i class="bi bi-bell me-2"></i>Run notifications</button>
                                            </form>
                                        </li>
                                    }
                                    @if (canViewJobs)
                                    {
                                        <li><a class="dropdown-item" asp-area="Admin" asp-controller="Jobs" asp-action="Index"><i class="bi bi-activity me-2"></i>Open jobs</a></li>
                                    }
                                    @if (canViewReports)
                                    {
                                        <li><a class="dropdown-item" asp-area="Admin" asp-controller="Reports" asp-action="Index"><i class="bi bi-clipboard-data me-2"></i>Open reports</a></li>
                                    }
                                    @if (!canRunJobs && !canViewJobs && !canViewReports)
                                    {
                                        <li><span class="dropdown-item-text text-muted small">No quick actions available.</span></li>
                                    }
                                </ul>
                            </div>
                        }
                        <a class="btn btn-light lw-btn d-flex align-items-center gap-1" href="/help/new-features">
                            <i class="bi bi-stars"></i>
                            <span class="d-none d-lg-inline">New features</span>
                        </a>
                        <button class="btn btn-light lw-btn lw-theme-toggle" type="button" data-theme-toggle aria-label="Toggle dark mode">
                            <i class="bi bi-moon-stars"></i>
                        </button>
                        @if (isSignedIn)
                        {
                            <div class="dropdown">
                                <button class="btn btn-light lw-btn rounded-pill d-flex align-items-center gap-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span class="avatar-circle">@avatarInitial</span>
                                    <span class="text-truncate max-w-160">@userName</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-person-circle me-2"></i>Profile (coming soon)</a></li>
                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                            <button type="submit" class="dropdown-item text-danger"><i class="bi bi-box-arrow-right me-2"></i>Sign out</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <a class="btn btn-primary lw-btn rounded-pill" asp-controller="Account" asp-action="Login">
                                <i class="bi bi-box-arrow-in-right me-1"></i> Sign in
                            </a>
                        }
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="lw-shell__body">
        @if (isAdminArea && hasAdminAccess)
        {
            <aside class="lw-sidebar d-none d-lg-flex">
                <div class="lw-sidebar__scroll">
                    <div class="lw-sidebar__section">
                        <div class="lw-sidebar__heading">Overview</div>
                        <a class="lw-nav-link @(NavActive("Home") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Home" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.DashboardView)">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    <div class="lw-sidebar__section">
                        <div class="lw-sidebar__heading">Portfolio</div>
                        <a class="lw-nav-link @(NavActive("Licenses") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Licenses" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.LicensesView)">
                            <i class="bi bi-file-earmark-check"></i>
                            <span>Licenses</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Categories") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Categories" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.CategoriesManage)">
                            <i class="bi bi-tags"></i>
                            <span>Categories</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Import") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Import" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.ImportManage)">
                            <i class="bi bi-cloud-arrow-up"></i>
                            <span>Import</span>
                        </a>
                        <a class="lw-nav-link @(NavActiveAction("Reports", "Usage") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Reports" asp-action="Usage" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.UsageView)">
                            <i class="bi bi-graph-up"></i>
                            <span>Usage</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Compliance") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Compliance" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.ComplianceView)">
                            <i class="bi bi-shield-exclamation"></i>
                            <span>Compliance</span>
                        </a>
                    </div>
                    <div class="lw-sidebar__section">
                        <div class="lw-sidebar__heading">Operations</div>
                        <a class="lw-nav-link @(NavActive("Email") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Email" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.EmailView)">
                            <i class="bi bi-envelope-paper-heart"></i>
                            <span>Email</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Jobs") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Jobs" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.JobsView)">
                            <i class="bi bi-activity"></i>
                            <span>Jobs</span>
                        </a>
                        <a class="lw-nav-link @((NavActive("Reports") && !NavActiveAction("Reports", "Usage")) ? "active" : string.Empty)" asp-area="Admin" asp-controller="Reports" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.ReportsView)">
                            <i class="bi bi-clipboard-data"></i>
                            <span>Reports</span>
                        </a>
                        <a class="lw-nav-link @(NavActiveAny("Optimization", "Recommendations") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Optimization" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.OptimizationView)">
                            <i class="bi bi-lightbulb"></i>
                            <span>Optimization</span>
                        </a>
                    </div>
                    <div class="lw-sidebar__section">
                        <div class="lw-sidebar__heading">System</div>
                        <a class="lw-nav-link @(NavActive("Maintenance") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Maintenance" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.MaintenanceView)">
                            <i class="bi bi-tools"></i>
                            <span>Maintenance</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("System") ? "active" : string.Empty)" asp-area="Admin" asp-controller="System" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.SystemView)">
                            <i class="bi bi-heart-pulse"></i>
                            <span>System</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Security") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Security" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.SecurityView)">
                            <i class="bi bi-shield-check"></i>
                            <span>Security</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Audit") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Audit" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.AuditView)">
                            <i class="bi bi-journal-text"></i>
                            <span>Audit</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Users") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Users" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.UsersView)">
                            <i class="bi bi-people"></i>
                            <span>Users</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Roles") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Roles" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.RolesView)">
                            <i class="bi bi-award"></i>
                            <span>Roles</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Settings") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Settings" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.SettingsManage)">
                            <i class="bi bi-gear-wide-connected"></i>
                            <span>Settings</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Database") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Database" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.DatabaseManage)">
                            <i class="bi bi-hdd-network"></i>
                            <span>Database</span>
                        </a>
                        <a class="lw-nav-link @(NavActive("Migrations") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Migrations" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.MigrationsManage)">
                            <i class="bi bi-layers"></i>
                            <span>Migrations</span>
                        </a>
                    </div>
                </div>
            </aside>
        }

        <main class="lw-content @(isAdminArea ? "lw-content--admin" : string.Empty)">
            <div class="lw-page-content @(isAdminArea ? "lw-page-content--admin" : "lw-page-content--public")">
                <div class="lw-page-inner">
                    @RenderBody()
                </div>
            </div>
        </main>
    </div>

    <footer class="lw-footer mt-auto">
        <div class="container-fluid px-4 px-lg-5 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 text-muted small">
            <span>LicenseWatch · Executive-grade license governance</span>
            <span>@AppInfo.DisplayVersion · @environmentLabel</span>
        </div>
    </footer>

    <div id="lw-toast-host" class="lw-toast-container" aria-live="polite" aria-atomic="true"></div>

    @if (isAdminArea && hasAdminAccess)
    {
        <div class="offcanvas offcanvas-start lw-offcanvas" tabindex="-1" id="adminNav" aria-labelledby="adminNavLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="adminNavLabel">Admin navigation</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <nav class="lw-offcanvas-nav">
                    <a class="lw-nav-link @(NavActive("Home") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Home" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.DashboardView)">
                        <i class="bi bi-speedometer2"></i>
                        <span>Dashboard</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Licenses") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Licenses" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.LicensesView)">
                        <i class="bi bi-file-earmark-check"></i>
                        <span>Licenses</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Categories") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Categories" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.CategoriesManage)">
                        <i class="bi bi-tags"></i>
                        <span>Categories</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Import") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Import" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.ImportManage)">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <span>Import</span>
                    </a>
                    <a class="lw-nav-link @(NavActiveAction("Reports", "Usage") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Reports" asp-action="Usage" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.UsageView)">
                        <i class="bi bi-graph-up"></i>
                        <span>Usage</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Compliance") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Compliance" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.ComplianceView)">
                        <i class="bi bi-shield-exclamation"></i>
                        <span>Compliance</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Email") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Email" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.EmailView)">
                        <i class="bi bi-envelope-paper-heart"></i>
                        <span>Email</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Jobs") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Jobs" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.JobsView)">
                        <i class="bi bi-activity"></i>
                        <span>Jobs</span>
                    </a>
                    <a class="lw-nav-link @((NavActive("Reports") && !NavActiveAction("Reports", "Usage")) ? "active" : string.Empty)" asp-area="Admin" asp-controller="Reports" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.ReportsView)">
                        <i class="bi bi-clipboard-data"></i>
                        <span>Reports</span>
                    </a>
                    <a class="lw-nav-link @(NavActiveAny("Optimization", "Recommendations") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Optimization" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.OptimizationView)">
                        <i class="bi bi-lightbulb"></i>
                        <span>Optimization</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Maintenance") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Maintenance" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.MaintenanceView)">
                        <i class="bi bi-tools"></i>
                        <span>Maintenance</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("System") ? "active" : string.Empty)" asp-area="Admin" asp-controller="System" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.SystemView)">
                        <i class="bi bi-heart-pulse"></i>
                        <span>System</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Security") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Security" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.SecurityView)">
                        <i class="bi bi-shield-check"></i>
                        <span>Security</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Audit") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Audit" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.AuditView)">
                        <i class="bi bi-journal-text"></i>
                        <span>Audit</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Users") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Users" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.UsersView)">
                        <i class="bi bi-people"></i>
                        <span>Users</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Roles") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Roles" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.RolesView)">
                        <i class="bi bi-award"></i>
                        <span>Roles</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Settings") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Settings" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.SettingsManage)">
                        <i class="bi bi-gear-wide-connected"></i>
                        <span>Settings</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Database") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Database" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.DatabaseManage)">
                        <i class="bi bi-hdd-network"></i>
                        <span>Database</span>
                    </a>
                    <a class="lw-nav-link @(NavActive("Migrations") ? "active" : string.Empty)" asp-area="Admin" asp-controller="Migrations" asp-action="Index" asp-authorize asp-authorize-policy="@PermissionPolicies.For(PermissionKeys.MigrationsManage)">
                        <i class="bi bi-layers"></i>
                        <span>Migrations</span>
                    </a>
                </nav>
            </div>
        </div>
    }

    <script src="~/lib/jquery/dist/jquery.min.js" nonce="@cspNonce"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js" nonce="@cspNonce"></script>
    <script src="~/js/site.js" asp-append-version="true" nonce="@cspNonce"></script>
    <script src="~/js/ui.js" asp-append-version="true" nonce="@cspNonce"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

@functions {
    private bool NavActive(string controllerName)
    {
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
        return string.Equals(controllerName, currentController, StringComparison.OrdinalIgnoreCase);
    }

    private bool NavActiveAny(params string[] controllers)
    {
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
        return controllers.Any(controllerName =>
            string.Equals(controllerName, currentController, StringComparison.OrdinalIgnoreCase));
    }

    private bool NavActiveAction(string controllerName, string actionName)
    {
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
        var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
        return string.Equals(controllerName, currentController, StringComparison.OrdinalIgnoreCase)
               && string.Equals(actionName, currentAction, StringComparison.OrdinalIgnoreCase);
    }
}
